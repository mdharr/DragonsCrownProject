<div class="wrapper" #observedElement>
  <app-navbar></app-navbar>
  <!-- Background video container -->
  <div id="video-background-container">
    <iframe id="video-background-player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share;" title="Background Video" src="https://www.youtube-nocookie.com/embed/dfyrRsYAAdo?controls=0&showinfo=0&modestbranding=1&wmode=transparent&vq=large&rel=0&loop=1&playlist=dfyrRsYAAdo&enablejsapi=1&autoplay=1&mute=1"></iframe>
  </div>
  <!-- <div style="height:100%;">
    <app-particles></app-particles>
  </div> -->
  <!-- Overlay -->
  <div class="bg-overlay"></div>

  <!-- Main content area -->
  <div class="main">
    <div class="content" [ngStyle]="{'--red_bg': 'url(' + getImageUrl('red_bg') + ')'}">
      <div class="gdiv">
        <!-- <img src="https://atlus.com/dragonscrown/img/home/gargoylediv.png" alt=""> -->
        <img src="https://dragonscrown.s3.amazonaws.com/DragonsCrownPatterns/gold_top_pattern.png" alt="">
      </div>
      <div class="middle">
        <div class="story-label" style="display: flex;">
          <!-- <div class="banner-wrapper">
            <img src="https://gamecloud.net.au/wp-content/uploads/2013/08/Dragons-Crown-Banner2-GameCloud.png" alt="Banner Image">
          </div> -->
          <!-- <div style="height: 100%; width: 300px;">
            <img style="height: -webkit-fill-available; width: auto;" src="https://c0.klipartz.com/pngpicture/327/764/gratis-png-dragon-s-crown-playstation-4-odin-esfera-princesa-crown-muramasa-demonio-blade-caballero-thumbnail.png" alt="">
          </div>
          <div style="height: 100%; width: 185px;">
            <img style="height: -webkit-fill-available; width: auto;" src="https://atlus.com/dragonscrown/img/story/dragon.png" alt="">
          </div> -->
          <app-particles style="overflow: hidden;"></app-particles>
          <!-- <div style="height:100%; z-index: 10;">
          </div> -->
        </div>
        <hr>
        <p style="background-color: rgba(0, 0, 0, 0.01);" class="small-text">Select a class to get started:</p>
        <!-- In your component template -->
        <div class="portraits">
          <ul id="portraits-ul" style="margin-bottom: 0;">
            <li *ngFor="let classData of playerClasses; let i = index" [id]="classData.id"
                (click)="loadClassData(i)"
                [ngClass]="{'selected': selectedClassIndex === i, 'unselected': selectedClassIndex !== i}"
                (mouseenter)="showTooltip($event, classData.animationUrl, i)"
                (mouseleave)="hideTooltip()">
                <div *ngIf="selectedClassIndex === i" class="chara-pointer">
                  <img src="https://www.4gamer.net/img/sp_dragonscrown/img_dc_chara_pointer.png">
                </div>
                <div class="portrait-container">
                  <img [src]="classData.portraitUrl" [alt]="classData.name">
                </div>
              <div *ngIf="tooltipVisible && tooltipIndex === i && selectedClassIndex !== i" class="custom-tooltip">
                <div class="media-wrapper">
                  <img [src]="classData.streamableUrl" alt="Media Content" style="width:100%; height: auto; max-height: 100%;">
                </div>
              </div>
            </li>
          </ul>
        </div>
        <hr>
        <!-- <div class="class-description class-backdrop" [style.backgroundImage]="'url(' + (currentClassData?.selectImgUrl || 'https://live.staticflickr.com/65535/53560863818_20e5c2da14_k.jpg') + ')'"> -->
        <div class="class-description class-backdrop" [style.backgroundImage]="'url(' + (currentClassData?.selectImgUrl || getImageUrl('character_bg')) + ')'">
          <!-- <div style="height:100%; z-index: 10;">
            <app-particles></app-particles>
          </div> -->
          <ng-container *ngIf="classSelected">
            <app-sprite-animation [className]="currentClassData?.name.toLowerCase()"></app-sprite-animation>
          </ng-container>
        </div>
        <!-- <div class="sheen-box" style="width:fit-content; height:fit-content; position:relative; z-index: 4;" *ngIf="playerCardLoaded">
          <img style="width: 140px;" src="{{ currentClassData?.iconUrl }}" alt="Skill Card">
        </div>
        <app-card-placeholder *ngIf="!playerCardLoaded"></app-card-placeholder> -->
        <!-- <p style="background-color: rgba(0, 0, 0, 0.01); margin: 0; padding: 0; min-height: 80px;" id="description-text"></p> -->
        <div class="planner" *ngIf="classSelected">
          <div class="n1-wrapper" [ngStyle]="{'--plannerBackgroundUrl': 'url(' + currentClassData?.paperUrl + ')'}">
            <div class="col n1 class-background">
              <div class="player-class">
                <label style="pointer-events:none;" for="class">Class</label>
                <div class="wrapper-class">
                  <span id="class-name">{{currentClassData?.name}}</span>
                </div>
              </div>
              <div class="mini-captions">
                <span>Attribute</span>
                <span>Current</span>
              </div>
              <div class="player-level">
                <label for="level">Level</label>
                <!-- <input id="level" type="text" [(ngModel)]="currentStats.level" (blur)="onLevelChange()" (keyup.enter)="onLevelChange()"> -->
                <input id="level" type="text" [(ngModel)]="currentStats.level" (blur)="onLevelChange()" (keyup)="onEnterPress($event)">
                <!-- Material button with an icon -->
                <button mat-icon-button class="arrow-buttons" id="down-arrow" (click)="levelDown()">
                  <mat-icon>keyboard_arrow_down</mat-icon>
                </button>

                <!-- Material icon button -->
                <button mat-icon-button class="arrow-buttons" id="up-arrow" (click)="levelUp()">
                  <mat-icon>keyboard_arrow_up</mat-icon>
                </button>

                <!-- <button mat-icon-button class="arrow-buttons" id="refresh-btn" (click)="resetLevel()"> -->
                <button mat-icon-button class="arrow-buttons" id="refresh-btn" (click)="setLevelToOne()">
                  <mat-icon>refresh</mat-icon>
                </button>
              </div>

              <div class="player-attributes">
                <div>
                  <label for="">HP</label>
                  <div class="stat-wrapper">
                    <span id="health" style="width: 46px; text-align: center;">{{currentStats?.health}}</span>
                  </div>
                  <div class="mini-captions" style="margin-left: 71px;">
                    <span>Scaling</span>
                  </div>
                </div>
                <div>
                  <label for="">STR</label>
                  <div class="stat-wrapper">
                    <span id="strength">{{currentStats?.strength}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="strength-scaling">{{ currentClassData?.statScaling?.strength }}</span>
                  </div>
                </div>
                <div>
                  <label for="">INT</label>
                  <div class="stat-wrapper">
                    <span id="intelligence">{{currentStats?.intelligence}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="intelligence-scaling">{{ currentClassData?.statScaling?.intelligence }}</span>
                  </div>
                </div>
                <div>
                  <label for="">CON</label>
                  <div class="stat-wrapper">
                    <span id="constitution">{{currentStats?.constitution}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="constitution-scaling">{{ currentClassData?.statScaling?.constitution }}</span>
                  </div>
                </div>
                <div>
                  <label for="">MGR</label>
                  <div class="stat-wrapper">
                    <span id="magic-resistance">{{currentStats?.magicResistance}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="magic-resistance-scaling">{{ currentClassData?.statScaling?.magicResistance }}</span>
                  </div>
                </div>
                <div>
                  <label for="">DEX</label>
                  <div class="stat-wrapper">
                    <span id="dexterity">{{currentStats?.dexterity}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="dexterity-scaling">{{ currentClassData?.statScaling?.dexterity }}</span>
                  </div>
                </div>
                <div>
                  <label for="">LUC</label>
                  <div class="stat-wrapper">
                    <span id="luck">{{currentStats?.luck}}</span>
                  </div>
                  <div class="scaling-wrapper">
                    <span id="luck-scaling">{{ currentClassData?.statScaling?.luck }}</span>
                  </div>
                </div>
                <!-- <div class="mini-captions exp-captions">
                  <span>Level Up</span>
                  <span>Total</span>
                </div> -->
                <div style="margin-top: 10px;">
                  <label for="">EXP</label>
                  <div class="exp-box">
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                      <div class="mini-captions exp-captions" style="width: 110px;">
                        <!-- <span>Level Up</span> -->
                        <span>Next Level</span>
                      </div>
                      <div class="stat-wrapper exp-wrapper">
                        <!-- <span id="exp">{{currentStats?.requiredExp}}</span> -->
                        <span id="exp">{{ this.getRequiredExpForNextLevel()}}</span>
                      </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 7px;">
                      <div class="mini-captions exp-captions">
                        <span>Total</span>
                      </div>
                      <div class="stat-wrapper exp-wrapper">
                        <span id="exp">{{totalExp}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="alt-artwork">
              <div class="class-contract" [ngStyle]="{'--backgroundImageUrl': 'url(' + 'https://static.myfigurecollection.net/upload/pictures/2021/04/24/2697957.gif' + ')'}">
                <span>Level {{ currentStats.level }} {{ currentClassData.name }}</span>
              </div>
              <!-- <img [hidden]="!artworkLoaded" style="height: 100%; width: auto;" [src]="currentClassData?.hqArtworkUrl" (load)="onArtworkLoad()" alt="High-quality artwork">
              <img *ngIf="!artworkLoaded" style="height: 100%; width: auto;" [src]="currentClassData?.artworkUrl" alt="Low-quality artwork"> -->
              <blockquote>
                <h5>Recommended for these people</h5>
                <ul>
                  <li *ngFor="let recommendation of currentClassData?.recommendations">{{ recommendation.description}}</li>
                </ul>
              </blockquote>
            </div>
          </div>
          <hr>
          <!-- <hr class="custom-hr" /> -->
          <!-- <div style="display: flex; flex-direction: row; justify-content: space-between;">
            <div class="n3">
              <div class="gif-crt"></div>
              <div class="class-title">
                <img id="title-img" [src]="currentClassData?.titleUrl" alt="banner">
              </div>
              <div class="position-gif">
                <div class="gif-wrapper">
                  <img class="gif-animation" [src]="currentClassData?.animationUrl" alt="animation">
                </div>
              </div>
            </div>
            <blockquote>
              <h5>Recommended for these people</h5>
              <ul>
                <li *ngFor="let recommendation of currentClassData?.recommendations">{{ recommendation.description}}</li>
              </ul>
            </blockquote>
          </div> -->
          <!-- <hr style="margin-top: 0;"> -->
        </div>
        <ng-container *ngIf="classSelected">
          <hr>
          <button id="common-btn" [class.selected-skills]="showCommonSkills && !viewQuests && !viewBuild" mat-button (click)="viewCommonSkills()">Common Skills</button>
          <button id="unique-btn" [class.selected-skills]="!showCommonSkills && !viewQuests && !viewBuild" mat-button (click)="viewUniqueSkills()">Unique Skills</button>
          <button id="quests-btn" [class.selected-skills]="viewQuests && !viewBuild" mat-button (click)="viewQuestList()">View Quests</button>
          <button id="build-btn" [class.selected-skills]="viewBuild && !viewQuests" mat-button (click)="viewCurrentBuild()">View Build</button>
        </ng-container>
        <!-- <div class="meta-wrapper class-background" *ngIf="classSelected && !viewQuests && !viewBuild" [ngStyle]="{'--backgroundImageUrl': 'url(' + currentClassData?.backgroundUrl + ')'}"> -->
        <!-- <div class="meta-wrapper class-background" *ngIf="classSelected && !viewQuests && !viewBuild" [ngStyle]="{'--backgroundImageUrl': 'url(' + 'https://ams3.digitaloceanspaces.com/web01.ho-sting/videogamesartwork_com/public/concept-art/1590653347/dragonscrown_environment_castle_town.png' + ')'}"> -->
        <div class="meta-wrapper class-background" *ngIf="classSelected && !viewQuests && !viewBuild" [ngStyle]="{'--backgroundImageUrl': 'url(' + getImageUrl('castle_bg') + ')'}">
          <div style="display: flex; flex-direction: column;">
            <span class="remaining-sp">Remaining Skill Points: {{ totalAvailableSP }}</span>

            <div class="common-unique-wrapper" style="display: flex; flex-direction: column;">

              <ng-container *ngIf="showCommonSkills">
                <div class="sheen-box" style="display: flex; justify-content: center; width: 100%; position:relative; z-index: 4;" *ngIf="playerCardLoaded">
                  <img class="skill-cards tilt" src="https://static.wikia.nocookie.net/dragons-crown/images/9/92/Common_skills.jpg" alt="Skill Card">
                </div>
                <app-card-placeholder *ngIf="!playerCardLoaded"></app-card-placeholder>
                <h3><span style="color: #d9b359;">Common Skills</span>: Can be learned by all classes.</h3>
              </ng-container>

              <ng-container *ngIf="!showCommonSkills">
                <div class="sheen-box" style="display: flex; justify-content: center; width: 100%; position:relative; z-index: 4;" *ngIf="playerCardLoaded">
                  <img class="skill-cards tilt" src="{{ currentClassData.cardUrl }}" alt="Skill Card">
                </div>
                <app-card-placeholder *ngIf="!playerCardLoaded"></app-card-placeholder>
                <h3><span style="color: #d9b359;">Unique Skills</span>: Can only be learned by one class.</h3>
              </ng-container>
              <!-- <span class="remaining-sp">Remaining Skill Points: {{ totalAvailableSP }}</span> -->

              <div class="common-skills" *ngIf="showCommonSkills">
                <div class="skillListWrap" *ngFor="let commonSkill of commonSkills; let i = index">
                  <dl>
                    <dt (click)="selectSkill(i, 'common')" [ngClass]="{'selected-skill': selectedSkill.index === i && selectedSkill.type === 'common'}">
                      {{ commonSkill.name }}
                      <span class="btn-base" (click)="removeSkillsByName(commonSkill.name, $event)"><mat-icon>close</mat-icon></span>
                    </dt>
                    <dd>
                      <ol>
                        <li *ngFor="let skillDetail of commonSkill.skillDetails; last as last" (click)="handleSkillClick(commonSkill, skillDetail)" [ngClass]="{'selected-rank': isSkillDetailSelected(commonSkill, skillDetail)}">{{ last ? "MAX" : "Lv" + skillDetail.rank }}</li>
                      </ol>
                    </dd>
                  </dl>
                </div>
              </div>
              <div class="unique-skills" *ngIf="!showCommonSkills">
                <div class="skillListWrap" *ngFor="let uniqueSkill of uniqueSkills; let i = index">
                  <dl>
                    <dt (click)="selectSkill(i, 'unique')" [ngClass]="{'selected-skill': selectedSkill.index === i && selectedSkill.type === 'unique'}">
                      {{ uniqueSkill.name }}
                      <span class="btn-base" (click)="removeSkillsByName(uniqueSkill.name, $event)"><mat-icon>close</mat-icon></span>
                    </dt>
                    <dd>
                      <ol>
                        <li *ngFor="let skillDetail of uniqueSkill.skillDetails; last as last" (click)="handleSkillClick(uniqueSkill, skillDetail)" [ngClass]="{'selected-rank': isSkillDetailSelected(uniqueSkill, skillDetail)}">{{ last ? "MAX" : "Lv" + skillDetail.rank }}</li>
                      </ol>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
          <ng-container *ngIf="skillSelected && !viewQuests">
            <div class="skillInfoBoard" #skillInfoBoard>
              <div>
                <div class="skill-card-wrapper">
                  <div class="sheen-box" style="width:fit-content; height:fit-content; position:relative;" *ngIf="skillCardLoaded">
                    <img class="skill-cards tilt" src="{{ currentSkill.cardImageUrl }}" alt="Skill Card">
                  </div>
                  <app-card-placeholder *ngIf="!skillCardLoaded"></app-card-placeholder>
                </div>
                <h3><span style="color: #d9b359;">{{ currentSkill.name }}</span>: {{ currentSkill.description }}</h3>
                <table>
                  <tbody>
                    <tr>
                      <th>
                        <font>
                          <font>Rank</font>
                        </font>
                      </th>
                      <th>
                        <font>
                          <font>Required SP</font>
                        </font>
                      </th>
                      <th>
                        <font>
                          <font>Required Level</font>
                        </font>
                      </th>
                      <th>
                        <font>
                          <font>Similar SL</font>
                        </font>
                      </th>
                      <th>
                        <font>
                          <font>Effects</font>
                        </font>
                      </th>
                    </tr>
                    <tr *ngFor="let detail of currentSkill.skillDetails;" [ngClass]="{ 'highlighted-row': this.isSkillDetailSelected(currentSkill, detail), 'highest-selected-rank': this.isSkillDetailHighestRank(currentSkill, detail) }">
                      <th>{{ detail.rank }}</th>
                      <td>{{ detail.requiredSkillPoints }}</td>
                      <td>{{ detail.requiredPlayerLevel }}</td>
                      <td>{{ detail.similarSkillLevel }}</td>
                      <td><span *ngFor="let effect of detail.effects.split(', ')">{{ effect }}<br></span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              </div>
          </ng-container>
        </div>
        <!-- <div class="meta-wrapper class-background" *ngIf="classSelected && viewQuests" [ngStyle]="{'--backgroundImageUrl': 'url(' + currentClassData?.backgroundUrl + ')'}"> -->
        <div class="meta-wrapper class-background" *ngIf="classSelected && viewQuests" [ngStyle]="{'--backgroundImageUrl': 'url(' + currentClassData?.hqArtworkUrl+ ')'}">
          <div class="quests-wrapper">
            <span style="margin-bottom: 5px;">Skill Points from Quests: {{ calculateTotalSkillPoints() }}</span>
            <table>
              <thead>
                <tr>
                  <th>
                    <input type="checkbox"
                           [checked]="areAllQuestsSelected()"
                           (change)="toggleAllQuests($event)">
                  </th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>SP</th>
                  <th>Location</th>
                  <th>Path</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let quest of quests">
                  <td>
                    <input type="checkbox"
                           [checked]="quest.selected"
                           (change)="toggleQuest(quest)">
                  </td>
                  <td>{{ quest.name }}</td>
                  <td>{{ quest.description }}</td>
                  <td>{{ quest.skillPoints }}</td>
                  <td>{{ quest.location }}</td>
                  <td>{{ quest.path }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div style="padding-bottom: 15px;" class="meta-wrapper build-background" *ngIf="classSelected && viewBuild && !viewQuests" [ngStyle]="{'--backgroundImageUrl': 'url(' + getImageUrl('build_bg') + ')'}">
          <div *ngIf="!currentBuild.length" style="min-height: 500px; color: #ffffff;" class="build-placeholder">
            <h3>Unlock skills to start planning out your build!</h3>
          </div>
          <div class="build-wrapper" style="width: 100%;" *ngIf="currentBuild.length">
            <div style="display: flex; width: 100%; justify-content: center; align-items: center;">
            </div>
            <!-- <hr>
            <div class="cards-wrapper">
              <div *ngFor="let skill of currentBuild" class="card" style="background-image: url('{{ skill.cardImageUrl }}');">
                <div class="card-content">{{ skill.name }}</div>
              </div>
            </div>
            <hr> -->
            <div style="display: flex; width: 100%; justify-content: space-between;">
              <span>Level {{ currentStats.level }} {{ currentClassData.name }}</span>
              <!-- <span style="cursor: pointer;" [matMenuTriggerFor]="menu" (click)="playConfirmAudio();">Options</span> -->
              <span style="cursor: pointer;" [matMenuTriggerFor]="menu" (click)="playSound('confirm')">Options</span>
              <mat-menu #menu="matMenu">
                <button class="custom-button" [ngClass]="{'with-icon': showAll}" mat-menu-item (click)="toggleDisplayOption('all')">Show By Insert Order <mat-icon class="checkmark-icon" *ngIf="showAll">check</mat-icon></button>
                <button class="custom-button" [ngClass]="{'with-icon': showByNameAsc}" mat-menu-item (click)="toggleDisplayOption('name_asc')">Show By Name Asc <mat-icon *ngIf="showByNameAsc">check</mat-icon></button>
                <button class="custom-button" [ngClass]="{'with-icon': showByNameDesc}" mat-menu-item (click)="toggleDisplayOption('name_desc')">Show By Name Desc <mat-icon *ngIf="showByNameDesc">check</mat-icon></button>
                <button class="custom-button" [ngClass]="{'with-icon': showBySPAsc}" mat-menu-item (click)="toggleDisplayOption('sp_asc')">Show By SP Asc <mat-icon *ngIf="showBySPAsc">check</mat-icon></button>
                <button class="custom-button" [ngClass]="{'with-icon': showBySPDesc}" mat-menu-item (click)="toggleDisplayOption('sp_desc')">Show By SP Desc <mat-icon *ngIf="showBySPDesc">check</mat-icon></button>
                <button class="custom-button" mat-menu-item (click)="captureAndDownloadScreenshot()">Export Build</button>
              </mat-menu>
            </div>
            <table class="build-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>SP Spent</th>
                  <th>Rank</th>
                  <th>Effects</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let skill of currentBuild">
                  <td>{{ skill.name }}</td>
                  <td>{{ skill.description }}</td>
                  <td>{{ skill | calculateTotalSP:currentClassData.skills }}</td>
                  <!-- <td>{{ this.calculateSP(skill, currentClassData.skills) }}</td> -->
                  <td>{{ skill.rank }}</td>
                  <td class="build-effects-wrapper">
                    <ul class="build-effects">
                      <li *ngFor="let effect of skill.effects.split(', ')">{{ effect }}</li>
                    </ul>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div style="padding-top: 15px;" *ngIf="classSelected && viewBuild && this.currentBuild.length > 0">
          <textarea style="width: 100%; background-color: rgb(21 43 56); color: #fff; padding: 10px; border-color: #cab35c;" readonly rows="10" [value]="generateBuildDataAsText()"></textarea>
          <button (click)="copyBuildToClipboard()">Copy Build Data</button>
          <button (click)="exportBuildAsTextFile()">Export as Text File</button>
        </div>
      </div>
      <div class="bdiv">
        <img src="https://dragonscrown.s3.amazonaws.com/DragonsCrownPatterns/gold_bottom_pattern.png" alt="">
      </div>
    </div>
    <app-scroll-to-top-button></app-scroll-to-top-button>
    <div class="footer">
      <div class="footer-text">
        <p>©2024 Dragon's Crown Planner | Michael Harrington</p>
      </div>
    </div>
  </div>
</div>

